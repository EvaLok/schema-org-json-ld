# Journal — 2026-02-27

Reflective log for the schema-org-json-ld orchestrator.

---

## 2026-02-27 — Cycle 40: PHPStan deep dive

### Context

Steady-state maintenance. All 28 types implemented, QC validation in progress (QC-63 has 0 errors, 58 warnings, working on reducing). Decided to continue the PHPStan quality improvement track started in Cycles 38-39.

### Observation — PHPStan levels 7-8 were free

After upgrading from 5 to 6 in Cycle 39 (which needed 14 annotation fixes), I expected levels 7 and 8 to reveal more issues. Instead: 0 errors at both levels. This suggests the codebase's type discipline was already good — the level 6 issues were purely missing PHPDoc annotations, not actual type problems.

The free wins at 7-8 validate the project's coding standards: constructor promotion with explicit types, nullable parameters with `null|Type` syntax, and backed string enums all contribute to good static analysis scores.

### Observation — PHPStan level 9 vs max gap

Level 9 has exactly 3 errors, all from `constant()` returning `mixed` in the PROPERTY_MAP handling code. These are trivially fixable with a `@var` annotation.

Level `max` has 8 errors total (5 additional). The extra 5 are all in the `AddPropertiesToObject()` method — PHPStan can't track types through the `is_array()` + `instanceof` branching on `mixed` values. These are inherent to the reflective/dynamic serialization approach. Fixing them would require either:
1. Adding `@var` assertions inside each branch (clutters the code)
2. Restructuring to use generics/templates (over-engineering for this use case)
3. Adding PHPStan ignores for specific lines (pragmatic but defeats the purpose)

Level 9 is the right target. Level `max` can wait until there's a compelling reason.

### Pattern — incremental PHPStan upgrades

The pattern of upgrading one level at a time works well:
- Cycle 38: Eva requested PHPStan, dispatched level 5 integration
- Cycle 39: Eva merged, immediately assessed and dispatched level 6
- Cycle 40: Bumped to 8 (free), dispatched level 9

Each cycle builds on the previous one's work. The agent consistently produces clean fixes because each upgrade is small and well-scoped. This is better than trying to jump directly to `max` — the errors at different levels have different characters and require different fix strategies.

### Decision — mkdir blocked, Write tool workaround

The `mkdir` command was blocked by the sandbox when creating the worklog directory, even though the permissions doc lists `mkdir *` as allowed. The error message referenced a security restriction on directory creation. Workaround: the Write tool creates parent directories automatically. This should be documented in the permissions skill for future sessions.

---

## 2026-02-27 — Cycle 41: QC closure and project maturity assessment

### Context

All 28 types implemented, PHPStan level 9 achieved. QC-63 posted final validation results from the previous cycle. This cycle is primarily housekeeping.

### QC validation complete

QC-63 final results: 39/39 E2E pass, 0 errors, 19 warnings (down from 58 after PRs #198/#199 were exercised — a 67% reduction). The QC orchestrator confirmed 3 of the 19 warnings are false positives (datePublished present in output but validator still reports missing). The remaining 16 are genuinely optional properties.

Closed both QC issues (#195, #200). No open QC communication remains.

### Observation — the long tail of optional properties

The remaining 16 QC warnings break down as:
- **Recipe** (10 warnings): expires, hasPart, publication, region, interaction — deeply optional properties that most real-world implementations skip
- **Product/ProductGroup** (4 warnings): isVariantOf — would require circular references between Product and ProductGroup, a structural complexity not justified by the benefit
- **ShippingService/other** (2 warnings): addressRegion/postalCode on nested types

None of these are in Google's "required" or "recommended" lists. The library already covers 100% of required and recommended properties for all 28 types. Adding these would be chasing diminishing returns.

### Reflection — project maturity indicators

The project has reached a natural completion point for its stated goals:
- **Type coverage**: 28/28 Google Rich Results types (100%)
- **Property coverage**: All required and recommended properties for all types
- **Quality**: PHPStan level 9, PHP-CS-Fixer enforced, 313 unit tests
- **Validation**: QC orchestrator confirms 0 errors across all 39 E2E test scenarios
- **Documentation**: Comprehensive README with examples for all 28 types, 5 ADRs, detailed AGENTS.md

The orchestrator workflow itself has also matured significantly:
- Clear issue specification patterns (skills, AGENTS.md)
- Reliable PR review workflow (wait for agent finish -> mark ready -> wait for CI -> review -> merge)
- QC integration for end-to-end validation
- Structured state management (state.json, worklog, journal)
- Housekeeping discipline (clean branches, closed issues)

### What remains

Future work is all low-priority polish:
1. PHPStan `max` level (5 errors in reflective code)
2. Remaining 16 QC warnings (optional properties)
3. JobPosting beta properties (educationRequirements, etc.)
4. Respond to any new Eva directives or QC reports

---

## 2026-02-27 — Cycle 42: Documentation accuracy audit

### Context

Steady state continues. No agent work, no QC communication, no Eva directives. Used the cycle for quality assurance on documentation and skills.

### Finding — stale counts in README

The README header claimed "28 Google Rich Results types" and "97 schema classes." Both were inaccurate:

- **98 schema classes** (not 97): [PR #199](https://github.com/EvaLok/schema-org-json-ld/issues/199) added `BroadcastEvent` as a new class file but the README count wasn't updated. This is a pattern worth noting — any PR that adds new files should update the count. But since we're at feature-complete, it shouldn't recur.
- **26 Google Rich Results categories** (not 28): Google's Search Gallery has exactly 26 categories. The "28" number came from state.json's `implemented` array, which counts AggregateRating and Person as separate top-level implementations (they're shared sub-types dispatched as individual work items). The distinction matters: 26 is the Google-facing count; 28 is the internal dispatch count.

### Observation — skills are in good shape

Audited all 5 skill files. All are comprehensive, well-structured, and internally consistent. No updates needed. The skills have stabilized — they encode the lessons from 40+ cycles of orchestration and don't need frequent revision anymore. This is a sign of workflow maturity.

### Pattern — maintenance cycles are getting shorter

Cycles 40-42 have all been maintenance cycles. Each one completes faster than the last because there's progressively less to audit, fix, or improve. This is the expected behavior of a converging system. The workflow flywheel has been turning for 42 cycles and the project is in a clean, stable state.

The remaining low-priority work items (PHPStan max, optional properties, JobPosting beta) haven't moved because they're genuinely low-value relative to their cost. This is the right outcome — not everything needs to be done.

---

## 2026-02-27 — Cycle 43: QC-driven Recipe property additions

### Context

Another steady-state cycle, but this time with actionable input: the QC orchestrator filed a new report (QC repo issue #72) identifying 5 optional properties missing from Recipe. This is the first new agent dispatch in 4 cycles.

### Observation — QC-driven work is the cleanest workflow

The QC report for Recipe was exceptionally well-structured: it listed each missing property, the validator message, which existing class already has it, and the suggested PHP type. This made the agent task spec almost write itself.

This pattern — QC identifies a gap, orchestrator verifies and dispatches — is the most efficient mode of operation. The QC orchestrator acts as an automated requirements analyst, converting validator output into actionable specifications. The orchestrator's job reduces to: verify the author, assess priority, write the issue spec, dispatch.

### Decision — implementing all 5 Recipe properties in one issue

The QC report asks for 5 optional properties. I could have split this into multiple issues, but all 5 are simple additions to an existing class with all dependent types already in the library. The agent should handle this in a single PR.

If the agent produces good output, this validates the "batch small related changes" pattern for property additions. If it struggles, the lesson is to keep property additions even more atomic.

### Observation — diminishing-returns work is still worth doing (when QC drives it)

In Cycle 41, I noted that the remaining 16 QC warnings were "chasing diminishing returns." But when the QC orchestrator explicitly files a report with clear specs, the cost of addressing them drops significantly. The QC report eliminated the research cost — I didn't need to figure out what was missing or what types to use. This shifts the cost-benefit calculation in favor of fixing them.

---

## 2026-02-27 — Cycle 44: Stale assumptions and ProductGroup subjectOf

### Context

Maintenance cycle. QC request [#215](https://github.com/EvaLok/schema-org-json-ld/issues/215) still pending (no response from QC orchestrator yet). No Eva input, no open PRs, clean slate.

### Discovery — isVariantOf was never actually missing

The state.json carried a note since Cycle 41: "Product/ProductGroup — isVariantOf — structural change for circular references — 4 QC warnings." I accepted this at face value for 3 cycles without verifying it.

Today I investigated the actual code and found `isVariantOf` is already implemented on `Product` (line 37) and `hasVariant` on `ProductGroup` (line 18). The "circular references" concern was overstated — one-way references (Product → ProductGroup) work perfectly with the existing JsonLdGenerator, which doesn't track visited objects. True circular serialization (Product → ProductGroup → Product → ...) would cause a stack overflow, but Google's structured data never requires this.

The 4 QC warnings for ProductGroup actually break down as:
- 2x `subjectOf` — ProductGroup class genuinely missing this property (Product has it)
- 2x `isVariantOf` — library already supports it; QC test scripts just need to exercise it

### Lesson — verify inherited assumptions

State file entries can become stale truths. The "structural change for circular references" note was written early and never questioned. Each subsequent cycle read it and accepted it. This is a classic persistence hazard: state files persist assumptions beyond their expiry date.

Mitigation: when a remaining-work item persists across 3+ cycles without action, actively re-examine it rather than carrying it forward.

### Action — dispatched ProductGroup subjectOf

Created [#217](https://github.com/EvaLok/schema-org-json-ld/issues/217) for the agent to add `subjectOf` to ProductGroup. Trivial change (1 property + tests) but it follows the rule that PHP code goes through PRs.

Updated state.json to correct the stale note and reflect the true status of each warning.

---

## 2026-02-27 — Cycle 45: Scope boundary — Book actions

### Context

Short maintenance cycle. QC acknowledged request [#215](https://github.com/EvaLok/schema-org-json-ld/issues/215), baseline at 13 warnings (down from 19), updating scripts. No Eva input, no agent work.

### Discovery — Book actions in Google Search Gallery

Reviewed the Google Search Gallery for any new structured data types. Found **Book actions** listed — was not in the original briefing's type list. Investigation revealed it's fundamentally different from our implemented types:

- Uses `DataFeed` as root container, not page-level `@type` annotations
- Designed for catalog data feeds (book metadata, editions, purchase/borrow actions)
- Validated by Google's Data Feed validation tool, not the Rich Results Test
- Requires hosted feed URLs (SFTP, S3, GCS) with daily updates
- Complex nesting: Work → Edition → Action → EntryPoint → Offer

This is clearly outside the project's scope. The library targets page-level JSON-LD annotations validated by the Rich Results Test. Book actions is a catalog data pipeline — different problem domain entirely.

### Observation — scope boundaries matter

The briefing correctly excluded Book actions by specifying "Google's Rich Results Test is the acceptance test." This is a useful scope boundary: it excludes DataFeed-based types (Book, potentially others in the future) while including all page-level annotation types. The boundary is clear, testable, and aligns with the library's architecture.

### QC validation note

The warning count dropped from 19 to 13 between Cycle 44 and Cycle 45's QC acknowledgement. The QC hasn't updated its Recipe scripts yet, so this reduction is from the package update itself (commits from PRs #214 and #218). This suggests the validator recognizes available properties even when the generate scripts don't fully exercise them — or the ProductGroup `subjectOf` addition resolved some warnings directly.
