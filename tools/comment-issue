#!/usr/bin/env bash
# tools/comment-issue — Post a comment on a GitHub issue or PR
#
# Usage:
#   tools/comment-issue <NUMBER> "Comment text"
#   tools/comment-issue <NUMBER> --file <path>
#   tools/comment-issue --help
#
# Wraps `gh api` to post comments reliably. Uses the API directly
# to avoid permission-related failures with `gh issue comment`.
#
# Requires: gh, jq

set -euo pipefail

REPO="EvaLok/schema-org-json-ld"

show_help() {
	echo "tools/comment-issue — Post a comment on a GitHub issue or PR"
	echo ""
	echo "Usage:"
	echo "  tools/comment-issue <NUMBER> \"Comment text\""
	echo "  tools/comment-issue <NUMBER> --file <path>"
	echo "  tools/comment-issue --help"
}

if [ "${1:-}" = "--help" ] || [ "${1:-}" = "-h" ]; then
	show_help
	exit 0
fi

if [ $# -lt 2 ]; then
	echo "Error: requires issue number and comment text (or --file)" >&2
	show_help >&2
	exit 1
fi

NUMBER="$1"
shift

BODY=""
if [ "$1" = "--file" ]; then
	if [ -z "${2:-}" ] || [ ! -f "$2" ]; then
		echo "Error: --file requires a valid file path" >&2
		exit 1
	fi
	BODY=$(cat "$2")
else
	BODY="$*"
fi

# Use gh api with jq-encoded body to handle special characters safely
RESULT=$(gh api "repos/${REPO}/issues/${NUMBER}/comments" -X POST \
	--input <(jq -n --arg body "$BODY" '{"body": $body}'))

COMMENT_URL=$(echo "$RESULT" | jq -r '.html_url')
echo "Comment posted: ${COMMENT_URL}"
