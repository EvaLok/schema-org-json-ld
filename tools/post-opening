#!/usr/bin/env bash
# tools/post-opening — Post the opening comment for an orchestrator session
#
# Usage:
#   tools/post-opening <ISSUE_NUMBER>
#   tools/post-opening --help
#
# Gathers session metadata and posts a formatted opening comment on the
# orchestrator issue. This replaces manual echo/comment commands that
# can trigger permission issues with environment variable expansion.
#
# Requires: gh, jq

set -euo pipefail

REPO="EvaLok/schema-org-json-ld"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

show_help() {
	echo "tools/post-opening — Post session opening comment"
	echo ""
	echo "Usage:"
	echo "  tools/post-opening <ISSUE_NUMBER>"
	echo "  tools/post-opening --help"
}

if [ "${1:-}" = "--help" ] || [ "${1:-}" = "-h" ]; then
	show_help
	exit 0
fi

if [ -z "${1:-}" ]; then
	echo "Error: issue number required" >&2
	show_help >&2
	exit 1
fi

ISSUE_NUM="$1"

# Gather session info
TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
RUN_ID="${GITHUB_RUN_ID:-unknown}"
MODEL="Claude Opus 4.6"

if [ "$RUN_ID" != "unknown" ]; then
	RUN_URL="https://github.com/${REPO}/actions/runs/${RUN_ID}"
	RUN_LINE="**Run:** [${RUN_ID}](${RUN_URL})"
else
	RUN_LINE="**Run ID:** unknown (not in Actions environment)"
fi

BODY="## Orchestrator Session Started

**Model:** ${MODEL}
**Time:** ${TIMESTAMP}
${RUN_LINE}
**Issue:** #${ISSUE_NUM}

Starting startup checklist."

# Post the comment
RESULT=$(gh api "repos/${REPO}/issues/${ISSUE_NUM}/comments" -X POST \
	--input <(jq -n --arg body "$BODY" '{"body": $body}'))

COMMENT_URL=$(echo "$RESULT" | jq -r '.html_url')
echo "Opening comment posted: ${COMMENT_URL}"
