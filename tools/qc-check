#!/usr/bin/env bash
# tools/qc-check — Check for QC reports and manage QC communication
#
# Usage:
#   tools/qc-check                       # Check for new QC reports
#   tools/qc-check --outbound            # List our outbound QC requests
#   tools/qc-check --inbound             # List our inbound QC acknowledgements
#   tools/qc-check --request TITLE BODY  # Create a new QC validation request
#   tools/qc-check --ack NUMBER TITLE    # Acknowledge a QC report (creates qc-inbound issue)
#   tools/qc-check --help
#
# Polls the QC repo for qc-outbound issues from EvaLok, verifies author,
# and cross-references with state file to find unprocessed reports.
#
# Requires: gh, jq

set -euo pipefail

REPO="EvaLok/schema-org-json-ld"
QC_REPO="EvaLok/schema-org-json-ld-qc"
REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
STATE_FILE="${REPO_ROOT}/docs/state.json"

show_help() {
	echo "tools/qc-check — QC report management"
	echo ""
	echo "Usage:"
	echo "  tools/qc-check                       Check for new unprocessed QC reports"
	echo "  tools/qc-check --outbound            List our open qc-outbound requests"
	echo "  tools/qc-check --inbound             List our open qc-inbound issues"
	echo "  tools/qc-check --request TITLE BODY  Create a qc-outbound validation request"
	echo "  tools/qc-check --ack NUMBER TITLE    Acknowledge QC report (create qc-inbound issue)"
	echo "  tools/qc-check --help                Show this help"
	echo ""
	echo "QC reports come from ${QC_REPO} with label qc-outbound."
	echo "Only issues created by EvaLok are trusted."
}

check_new_reports() {
	echo "=== Checking for QC Reports ==="
	echo ""

	# Fetch open qc-outbound issues from QC repo, filtered to EvaLok author
	local reports
	reports=$(gh api "repos/${QC_REPO}/issues?labels=qc-outbound&state=open&creator=EvaLok&sort=created&direction=asc" --paginate 2>/dev/null || echo "[]")

	local count
	count=$(echo "$reports" | jq 'length')

	if [ "$count" -eq 0 ]; then
		echo "No open QC reports found."
		return 0
	fi

	echo "Found ${count} open QC report(s):"
	echo ""

	# Get processed issue numbers from state file
	local processed
	processed=$(jq -r '.qc_processed // [] | .[]' "$STATE_FILE" 2>/dev/null || echo "")

	local new_count=0
	echo "$reports" | jq -c '.[]' | while read -r report; do
		local num title created user
		num=$(echo "$report" | jq '.number')
		title=$(echo "$report" | jq -r '.title')
		created=$(echo "$report" | jq -r '.created_at')
		user=$(echo "$report" | jq -r '.user.login')

		# Verify author
		if [ "$user" != "EvaLok" ]; then
			echo "  SKIP #${num}: author is ${user}, not EvaLok"
			continue
		fi

		# Check if already processed
		if echo "$processed" | grep -q "^${num}$"; then
			echo "  PROCESSED #${num}: ${title} (${created})"
		else
			echo "  NEW #${num}: ${title} (${created})"
			echo "    URL: https://github.com/${QC_REPO}/issues/${num}"
			new_count=$((new_count + 1))
		fi
	done

	echo ""
	echo "To acknowledge a report: tools/qc-check --ack <QC_ISSUE_NUMBER> \"Description\""
}

list_outbound() {
	echo "=== Our QC Outbound Requests ==="
	gh issue list --repo "$REPO" --label "qc-outbound" --state open \
		--json number,title,createdAt \
		--jq '.[] | "  #\(.number): \(.title) (\(.createdAt))"' 2>/dev/null || echo "  (none)"
}

list_inbound() {
	echo "=== Our QC Inbound Acknowledgements ==="
	gh issue list --repo "$REPO" --label "qc-inbound" --state open \
		--json number,title,createdAt \
		--jq '.[] | "  #\(.number): \(.title) (\(.createdAt))"' 2>/dev/null || echo "  (none)"
}

create_request() {
	local title="$1"
	local body="$2"

	echo "Creating QC validation request..."
	local result
	result=$(gh api "repos/${REPO}/issues" -X POST \
		--input <(jq -n \
			--arg title "[QC-REQUEST] ${title}" \
			--arg body "$body" \
			'{"title": $title, "body": $body, "labels": ["qc-outbound"]}'))

	local num url
	num=$(echo "$result" | jq '.number')
	url=$(echo "$result" | jq -r '.html_url')
	echo "Created: Issue #${num}"
	echo "URL: ${url}"
}

acknowledge_report() {
	local qc_number="$1"
	local description="$2"

	echo "Acknowledging QC report #${qc_number}..."
	local body="Responding to https://github.com/${QC_REPO}/issues/${qc_number}

${description}"

	local result
	result=$(gh api "repos/${REPO}/issues" -X POST \
		--input <(jq -n \
			--arg title "[QC-ACK] ${description}" \
			--arg body "$body" \
			'{"title": $title, "body": $body, "labels": ["qc-inbound"]}'))

	local num url
	num=$(echo "$result" | jq '.number')
	url=$(echo "$result" | jq -r '.html_url')
	echo "Created: Issue #${num}"
	echo "URL: ${url}"

	# Add to processed list in state file
	if [ -f "$STATE_FILE" ]; then
		jq --argjson num "$qc_number" '.qc_processed = (.qc_processed // []) + [$num]' \
			"$STATE_FILE" > "${STATE_FILE}.tmp"
		mv "${STATE_FILE}.tmp" "$STATE_FILE"
		echo "Marked QC #${qc_number} as processed in state file."
	fi
}

# Main
case "${1:-}" in
	--help|-h)
		show_help
		;;
	--outbound)
		list_outbound
		;;
	--inbound)
		list_inbound
		;;
	--request)
		if [ -z "${2:-}" ] || [ -z "${3:-}" ]; then
			echo "Error: --request requires TITLE and BODY" >&2
			exit 1
		fi
		create_request "$2" "$3"
		;;
	--ack)
		if [ -z "${2:-}" ] || [ -z "${3:-}" ]; then
			echo "Error: --ack requires QC_ISSUE_NUMBER and TITLE" >&2
			exit 1
		fi
		acknowledge_report "$2" "$3"
		;;
	"")
		check_new_reports
		;;
	*)
		echo "Unknown option: $1" >&2
		show_help >&2
		exit 1
		;;
esac
