#!/usr/bin/env bash
# tools/create-issue — Create a GitHub issue with proper JSON encoding
#
# Usage:
#   tools/create-issue --title "Title" --body "Body text" [--label LABEL]
#   tools/create-issue --title "Title" --body-file <path> [--label LABEL]
#   tools/create-issue --help
#
# Wraps `gh api` with proper JSON encoding via jq to avoid issues with
# special characters, multi-line bodies, and shell escaping.
#
# Requires: gh, jq

set -euo pipefail

REPO="EvaLok/schema-org-json-ld"

show_help() {
	echo "tools/create-issue — Create a GitHub issue"
	echo ""
	echo "Usage:"
	echo "  tools/create-issue --title \"Title\" --body \"Body\" [--label LABEL]..."
	echo "  tools/create-issue --title \"Title\" --body-file <path> [--label LABEL]..."
	echo "  tools/create-issue --help"
	echo ""
	echo "Options:"
	echo "  --title TITLE       Issue title (required)"
	echo "  --body BODY         Issue body text"
	echo "  --body-file FILE    Read issue body from file"
	echo "  --label LABEL       Add a label (can be repeated)"
}

TITLE=""
BODY=""
LABELS=()

while [[ $# -gt 0 ]]; do
	case "$1" in
		--title) TITLE="$2"; shift 2 ;;
		--body) BODY="$2"; shift 2 ;;
		--body-file)
			if [ ! -f "$2" ]; then
				echo "Error: file not found: $2" >&2
				exit 1
			fi
			BODY=$(cat "$2")
			shift 2
			;;
		--label) LABELS+=("$2"); shift 2 ;;
		--help|-h) show_help; exit 0 ;;
		*) echo "Unknown option: $1" >&2; show_help >&2; exit 1 ;;
	esac
done

if [ -z "$TITLE" ]; then
	echo "Error: --title is required" >&2
	show_help >&2
	exit 1
fi

# Build labels JSON array
LABELS_JSON="[]"
if [ ${#LABELS[@]} -gt 0 ]; then
	LABELS_JSON=$(printf '%s\n' "${LABELS[@]}" | jq -R . | jq -s .)
fi

# Create issue via API with jq-encoded JSON (safe for all characters)
RESULT=$(gh api "repos/${REPO}/issues" -X POST \
	--input <(jq -n \
		--arg title "$TITLE" \
		--arg body "$BODY" \
		--argjson labels "$LABELS_JSON" \
		'{"title": $title, "body": $body, "labels": $labels}'))

ISSUE_NUM=$(echo "$RESULT" | jq '.number')
ISSUE_URL=$(echo "$RESULT" | jq -r '.html_url')

echo "Created: Issue #${ISSUE_NUM}"
echo "URL: ${ISSUE_URL}"
