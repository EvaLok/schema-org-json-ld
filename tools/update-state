#!/usr/bin/env bash
# tools/update-state — Atomically update state.json and create/update worklog entries
#
# Usage:
#   tools/update-state --read                      # Print current state.json
#   tools/update-state --set-field KEY VALUE        # Set a top-level field in state.json
#   tools/update-state --add-implemented TYPE PR ISSUE [SUB_TYPES...]
#                                                   # Add a type to implemented list
#   tools/update-state --add-in-progress TYPE ISSUE # Mark a type as in-progress
#   tools/update-state --clear-in-progress TYPE     # Remove a type from in-progress
#   tools/update-state --set-cycle ISSUE SUMMARY    # Update last_cycle info
#   tools/update-state --add-agent-session ISSUE MODEL TYPES
#                                                   # Track a dispatched agent session
#   tools/update-state --remove-agent-session ISSUE # Remove a completed agent session
#   tools/update-state --worklog TITLE              # Create a new worklog entry (reads stdin)
#   tools/update-state --commit MESSAGE             # Git add, commit, push state+worklog
#   tools/update-state --help                       # Show help
#
# Requires: jq, git

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
STATE_FILE="${REPO_ROOT}/docs/state.json"
WORKLOG_DIR="${REPO_ROOT}/docs/worklog"

show_help() {
    echo "tools/update-state — Manage orchestrator state and worklog"
    echo ""
    echo "Commands:"
    echo "  --read                              Print current state.json"
    echo "  --set-field KEY VALUE               Set a top-level field (string/number)"
    echo "  --add-implemented TYPE PR ISSUE [SUB_TYPES...]"
    echo "                                      Add type to implemented list"
    echo "  --add-in-progress TYPE ISSUE        Mark type as in-progress"
    echo "  --clear-in-progress TYPE            Remove type from in-progress"
    echo "  --set-cycle ISSUE SUMMARY           Update last_cycle"
    echo "  --add-agent-session ISSUE MODEL TYPES"
    echo "                                      Add an agent session"
    echo "  --remove-agent-session ISSUE        Remove an agent session"
    echo "  --remove-planned TYPE               Remove type from planned_next"
    echo "  --worklog TITLE                     Create worklog entry (stdin = body)"
    echo "  --commit MESSAGE                    Commit and push state+worklog"
    echo ""
    echo "State file: ${STATE_FILE}"
    echo "Worklog dir: ${WORKLOG_DIR}"
}

ensure_state() {
    if [ ! -f "$STATE_FILE" ]; then
        echo "Error: ${STATE_FILE} not found" >&2
        exit 1
    fi
}

read_state() {
    ensure_state
    cat "$STATE_FILE"
}

write_state() {
    local tmp="${STATE_FILE}.tmp"
    cat > "$tmp"
    mv "$tmp" "$STATE_FILE"
}

set_field() {
    local key="$1" value="$2"
    ensure_state
    # Detect if value is numeric
    if echo "$value" | grep -qE '^[0-9]+$'; then
        jq --arg k "$key" --argjson v "$value" '.[$k] = $v' "$STATE_FILE" | write_state
    else
        jq --arg k "$key" --arg v "$value" '.[$k] = $v' "$STATE_FILE" | write_state
    fi
    echo "Set ${key} = ${value}"
}

add_implemented() {
    local type="$1" pr="$2" issue="$3"
    shift 3
    local sub_types=("$@")
    ensure_state

    local ts
    ts=$(date -u '+%Y-%m-%dT%H:%M:%SZ')

    if [ ${#sub_types[@]} -gt 0 ]; then
        local subs_json
        subs_json=$(printf '%s\n' "${sub_types[@]}" | jq -R . | jq -s .)
        jq --arg type "$type" --argjson pr "$pr" --argjson issue "$issue" \
           --arg ts "$ts" --argjson subs "$subs_json" \
           '.schema_status.implemented += [{"type": $type, "pr": $pr, "issue": $issue, "sub_types": $subs, "merged_at": $ts}]' \
           "$STATE_FILE" | write_state
    else
        jq --arg type "$type" --argjson pr "$pr" --argjson issue "$issue" --arg ts "$ts" \
           '.schema_status.implemented += [{"type": $type, "pr": $pr, "issue": $issue, "merged_at": $ts}]' \
           "$STATE_FILE" | write_state
    fi

    # Remove from planned_next if present
    jq --arg type "$type" '.schema_status.planned_next |= [.[] | select(.type != $type)]' \
       "$STATE_FILE" | write_state

    # Remove from not_implemented if present
    jq --arg type "$type" '.schema_status.google_rich_results_types.not_implemented |= [.[] | select(. != $type)]' \
       "$STATE_FILE" | write_state

    # Increment counts
    local current_types
    current_types=$(jq '.total_schema_types' "$STATE_FILE")
    jq --argjson n "$((current_types + 1))" '.total_schema_types = $n' "$STATE_FILE" | write_state

    if [ ${#sub_types[@]} -gt 0 ]; then
        local current_subs
        current_subs=$(jq '.total_sub_types' "$STATE_FILE")
        jq --argjson n "$((current_subs + ${#sub_types[@]}))" '.total_sub_types = $n' "$STATE_FILE" | write_state
    fi

    echo "Added ${type} (PR #${pr}, issue #${issue}) to implemented"
}

add_in_progress() {
    local type="$1" issue="$2"
    ensure_state
    jq --arg type "$type" --argjson issue "$issue" \
       '.schema_status.in_progress += [{"type": $type, "issue": $issue}]' \
       "$STATE_FILE" | write_state
    echo "Marked ${type} as in-progress (issue #${issue})"
}

clear_in_progress() {
    local type="$1"
    ensure_state
    jq --arg type "$type" '.schema_status.in_progress |= [.[] | select(.type != $type)]' \
       "$STATE_FILE" | write_state
    echo "Cleared ${type} from in-progress"
}

set_cycle() {
    local issue="$1" summary="$2"
    ensure_state
    local ts
    ts=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
    jq --argjson issue "$issue" --arg summary "$summary" --arg ts "$ts" \
       '.last_cycle = {"issue": $issue, "timestamp": $ts, "summary": $summary}' \
       "$STATE_FILE" | write_state
    echo "Updated last_cycle to issue #${issue}"
}

add_agent_session() {
    local issue="$1" model="$2" types="$3"
    ensure_state
    local ts
    ts=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
    jq --argjson issue "$issue" --arg model "$model" --arg types "$types" --arg ts "$ts" \
       '.agent_sessions += [{"issue": $issue, "model": $model, "types": $types, "dispatched_at": $ts}]' \
       "$STATE_FILE" | write_state
    echo "Added agent session for issue #${issue} (model: ${model})"
}

remove_agent_session() {
    local issue="$1"
    ensure_state
    jq --argjson issue "$issue" '.agent_sessions |= [.[] | select(.issue != $issue)]' \
       "$STATE_FILE" | write_state
    echo "Removed agent session for issue #${issue}"
}

remove_planned() {
    local type="$1"
    ensure_state
    jq --arg type "$type" '.schema_status.planned_next |= [.[] | select(.type != $type)]' \
       "$STATE_FILE" | write_state
    echo "Removed ${type} from planned_next"
}

create_worklog() {
    local title="$1"
    local date_dir
    date_dir=$(date -u '+%Y-%m-%d')
    local time_prefix
    time_prefix=$(date -u '+%H%M%S')
    local slug
    slug=$(echo "$title" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-')

    local dir="${WORKLOG_DIR}/${date_dir}"
    mkdir -p "$dir"

    local filepath="${dir}/${time_prefix}-${slug}.md"
    cat > "$filepath"
    echo "Created worklog: ${filepath}"
}

commit_state() {
    local message="$1"
    cd "$REPO_ROOT"
    git add docs/state.json docs/worklog/ JOURNAL.md 2>/dev/null || true
    git commit -m "$message" 2>/dev/null || { echo "Nothing to commit"; return 0; }
    git push 2>/dev/null || { echo "Warning: push failed"; return 1; }
    echo "Committed and pushed: ${message}"
}

# Main
case "${1:-}" in
    --help|-h)
        show_help
        ;;
    --read)
        read_state
        ;;
    --set-field)
        set_field "$2" "$3"
        ;;
    --add-implemented)
        shift
        add_implemented "$@"
        ;;
    --add-in-progress)
        add_in_progress "$2" "$3"
        ;;
    --clear-in-progress)
        clear_in_progress "$2"
        ;;
    --set-cycle)
        set_cycle "$2" "$3"
        ;;
    --add-agent-session)
        add_agent_session "$2" "$3" "$4"
        ;;
    --remove-agent-session)
        remove_agent_session "$2"
        ;;
    --remove-planned)
        remove_planned "$2"
        ;;
    --worklog)
        create_worklog "$2"
        ;;
    --commit)
        commit_state "$2"
        ;;
    *)
        echo "Unknown command: ${1:-}" >&2
        show_help >&2
        exit 1
        ;;
esac
