#!/usr/bin/env bash
# tools/review-pr — Check agent PR status, mark ready, verify CI, optionally merge
#
# Usage:
#   tools/review-pr <PR_NUMBER>             # Check status and mark ready if agent finished
#   tools/review-pr <PR_NUMBER> --merge     # Also merge after CI passes
#   tools/review-pr <PR_NUMBER> --wait-ci   # Wait for CI to complete (polls every 30s)
#   tools/review-pr --help
#
# Workflow:
#   1. Checks if the Copilot agent has finished work on the PR
#   2. If finished and still draft, marks the PR as ready for review (triggers CI)
#   3. Checks CI status
#   4. With --merge: squash-merges if CI passes
#
# Requires: gh, jq

set -euo pipefail

REPO="EvaLok/schema-org-json-ld"
CI_POLL_INTERVAL=30  # seconds between CI status checks
CI_POLL_MAX=20       # max polls (~10 minutes)

show_help() {
	echo "tools/review-pr — PR review workflow helper"
	echo ""
	echo "Usage:"
	echo "  tools/review-pr <PR_NUMBER>             Check status, mark ready if agent finished"
	echo "  tools/review-pr <PR_NUMBER> --merge     Also squash-merge if CI passes"
	echo "  tools/review-pr <PR_NUMBER> --wait-ci   Wait for CI checks to complete"
	echo "  tools/review-pr --help                  Show this help"
	echo ""
	echo "This tool implements the PR review workflow:"
	echo "  1. Check if copilot_work_finished event exists"
	echo "  2. Mark PR ready for review (removes draft, triggers CI)"
	echo "  3. Check CI workflow status"
	echo "  4. Optionally merge via --merge flag"
}

check_agent_finished() {
	local pr_num="$1"
	local events
	events=$(gh api "repos/${REPO}/issues/${pr_num}/timeline" --paginate \
		--jq '[.[] | select(.event != null) | select(.event | test("copilot_work")) | {event: .event, created_at: .created_at}]' 2>/dev/null || echo "[]")

	local finished
	finished=$(echo "$events" | jq '[.[] | select(.event == "copilot_work_finished")] | length' 2>/dev/null || echo "0")
	local started
	started=$(echo "$events" | jq '[.[] | select(.event == "copilot_work_started")] | length' 2>/dev/null || echo "0")

	echo "$events" | jq -r '.[] | "  \(.event) at \(.created_at)"' 2>/dev/null

	if [ "$finished" -gt 0 ]; then
		echo "  -> Agent work: FINISHED"
		return 0
	elif [ "$started" -gt 0 ]; then
		echo "  -> Agent work: IN PROGRESS (not finished yet)"
		return 1
	else
		echo "  -> Agent work: NO EVENTS (agent may not have started)"
		return 1
	fi
}

mark_ready() {
	local pr_num="$1"
	local is_draft
	is_draft=$(gh pr view "$pr_num" --repo "$REPO" --json isDraft --jq '.isDraft' 2>/dev/null)

	if [ "$is_draft" = "true" ]; then
		echo "  Marking PR #${pr_num} as ready for review..."
		gh pr ready "$pr_num" --repo "$REPO" 2>/dev/null
		echo "  -> PR marked ready. CI workflows will now run."
	else
		echo "  -> PR is already ready for review."
	fi
}

check_ci() {
	local pr_num="$1"
	echo "  CI checks:"
	gh pr checks "$pr_num" --repo "$REPO" 2>/dev/null || echo "    (no checks found)"
}

wait_for_ci() {
	local pr_num="$1"
	local polls=0

	echo "  Waiting for CI to complete (polling every ${CI_POLL_INTERVAL}s, max ${CI_POLL_MAX} polls)..."

	while [ "$polls" -lt "$CI_POLL_MAX" ]; do
		polls=$((polls + 1))
		sleep "$CI_POLL_INTERVAL"

		local status
		status=$(gh pr checks "$pr_num" --repo "$REPO" 2>/dev/null || echo "")

		# Check if any checks are still pending/in_progress
		local pending
		pending=$(echo "$status" | grep -cE "pending|in_progress|queued" || true)

		if [ "$pending" -eq 0 ] && [ -n "$status" ]; then
			echo "  -> CI complete after ${polls} polls."
			echo "$status"

			# Check for failures
			local failures
			failures=$(echo "$status" | grep -c "fail" || true)
			if [ "$failures" -gt 0 ]; then
				echo "  -> CI FAILED. Do not merge."
				return 1
			else
				echo "  -> CI PASSED."
				return 0
			fi
		fi

		echo "  Poll ${polls}/${CI_POLL_MAX}: still waiting..."
	done

	echo "  -> Timed out waiting for CI."
	return 1
}

do_merge() {
	local pr_num="$1"
	echo "  Squash-merging PR #${pr_num}..."
	gh pr merge "$pr_num" --repo "$REPO" --squash --delete-branch 2>/dev/null
	echo "  -> PR #${pr_num} merged and branch deleted."
}

# Parse arguments
PR_NUM=""
DO_MERGE=false
DO_WAIT_CI=false

while [[ $# -gt 0 ]]; do
	case "$1" in
		--help|-h) show_help; exit 0 ;;
		--merge) DO_MERGE=true; DO_WAIT_CI=true; shift ;;
		--wait-ci) DO_WAIT_CI=true; shift ;;
		*)
			if [ -z "$PR_NUM" ]; then
				PR_NUM="$1"
			else
				echo "Error: unexpected argument: $1" >&2
				show_help >&2
				exit 1
			fi
			shift
			;;
	esac
done

if [ -z "$PR_NUM" ]; then
	echo "Error: PR number required" >&2
	show_help >&2
	exit 1
fi

echo "=== PR #${PR_NUM} Review Workflow ==="
echo ""

# Step 1: Check PR metadata
echo "Step 1: PR metadata"
gh pr view "$PR_NUM" --repo "$REPO" --json title,state,isDraft,author,headRefName \
	--jq '"  Title: \(.title)\n  State: \(.state)\n  Draft: \(.isDraft)\n  Author: \(.author.login)\n  Branch: \(.headRefName)"' 2>/dev/null
echo ""

# Step 2: Check agent status
echo "Step 2: Agent work status"
if ! check_agent_finished "$PR_NUM"; then
	echo ""
	echo "STOP: Agent has not finished. Check back later."
	echo "  tools/review-pr ${PR_NUM}"
	exit 1
fi
echo ""

# Step 3: Mark ready for review
echo "Step 3: Mark ready for review"
mark_ready "$PR_NUM"
echo ""

# Step 4: CI checks
echo "Step 4: CI status"
if [ "$DO_WAIT_CI" = true ]; then
	if ! wait_for_ci "$PR_NUM"; then
		echo ""
		echo "STOP: CI failed. Review failures before proceeding."
		exit 1
	fi
else
	check_ci "$PR_NUM"
	echo "  (Use --wait-ci to poll until CI completes)"
fi
echo ""

# Step 5: Merge (optional)
if [ "$DO_MERGE" = true ]; then
	echo "Step 5: Merge"
	do_merge "$PR_NUM"
fi

echo "Done."
